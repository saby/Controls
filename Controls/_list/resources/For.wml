<ws:template name="ITEM">

    <!-- Дублирование блока - необходимая жертва. -->
    <!-- Редактируемую строку необходимо обернуть в контрол EditingRow. Сделать это прямо в цикле нельзя, т.к. -->
    <!-- за один шаг цикла может отрисоваться несколько записей, например шапка группы и добавляемая запись. -->
    <!-- В таком случае контрол обернет сразу две записи, что неверно. -->
    <!-- Выход только один - дублирование. Обернуть можно непосредственно при вызове рендера -->
    <!-- записи (шаблона ITEM), но тогда таких мест получится 6, либо здесь, внутри ITEM. -->

    <ws:if data="{{ wrapEditingRow }}">
        <!-- Во время редактирования строки View не должна слушать событие click и mouseDown -->
        <Controls._list.EditInPlace.EditingRow name="editingRow" on:deactivated="_onRowDeactivated()">
            <ws:partial
                    template="{{ (itemData.item.get && itemData.item.get(itemData.itemTemplateProperty)) || itemTemplate }}"
                    itemData="{{ itemData }}"

                    itemActionsTemplate="{{ itemActionsTemplate }}"
                    itemActionsClass="{{ itemActionsClass }}"
                    swipeTemplate="{{ swipeTemplate }}"
                    editArrowTemplate="{{ editArrowTemplate }}"
                    multiSelectTpl="{{ multiSelectTpl }}"
                    backgroundStyle="{{ backgroundStyle }}"
                    isColumnScrollVisible="{{ isColumnScrollVisible }}"
                    tagTemplate="{{ tagTemplate }}"

                    on:contextmenu="_onItemContextMenu(itemData)"
                    on:swipe="_onItemSwipe(itemData)"
                    on:mouseup="_onItemMouseUp(itemData)"
                    on:mouseenter="_onItemMouseEnter(itemData)"
                    on:mouseleave="_onItemMouseLeave(itemData)"
                    on:mousemove="_onItemMouseMove(itemData)"
                    on:wheel="_onItemWheel(itemData)"/>
        </Controls._list.EditInPlace.EditingRow>
    </ws:if>
    <ws:else>
        <ws:partial
                template="{{ (itemData.item.get && itemData.item.get(itemData.itemTemplateProperty)) || itemTemplate }}"
                itemData="{{ itemData }}"

                itemActionsTemplate="{{ itemActionsTemplate }}"
                itemActionsClass="{{ itemActionsClass }}"
                swipeTemplate="{{ swipeTemplate }}"
                editArrowTemplate="{{ editArrowTemplate }}"
                multiSelectTpl="{{ multiSelectTpl }}"
                backgroundStyle="{{ backgroundStyle }}"
                isColumnScrollVisible="{{ isColumnScrollVisible }}"
                tagTemplate="{{ tagTemplate }}"

                on:click="_onItemClick(itemData.dispItem)"
                on:contextmenu="_onItemContextMenu(itemData)"
                on:swipe="_onItemSwipe(itemData)"
                on:mousedown="_onItemMouseDown(itemData)"
                on:mouseup="_onItemMouseUp(itemData)"
                on:mouseenter="_onItemMouseEnter(itemData)"
                on:mouseleave="_onItemMouseLeave(itemData)"
                on:mousemove="_onItemMouseMove(itemData)"
                on:wheel="_onItemWheel(itemData)"/>
    </ws:else>
</ws:template>


<ws:for data="listModel.reset(); listModel.isEnd(); listModel.goToNext();">

    <ws:partial if="{{ listModel.getCurrent().beforeItemTemplate }}"
                template="{{ listModel.getCurrent().beforeItemTemplate }}"
                scope="{{ listModel.getCurrent().beforeItemTemplateOptions }}"
                itemTemplate="{{ itemTemplate }}"
                listModel="{{ listModel }}"/>


    <!-- Группа -->
    <ws:if data="{{ listModel.getCurrent().isGroup }}">
        <!-- Добавление в пустую скрытую группу -->
        <ws:partial if="{{ editingItemData && isAdd && listModel.getCurrent().index === 0 && editingItemData.index === 0 }}"
                    template="ITEM"
                    itemData="{{editingItemData}}"
                    attr:key="{{editingItemData.key}}"
                    wrapEditingRow="{{ true }}"/>

        <!-- Шаблон элемента -->
        <ws:partial template="{{groupTemplate}}"
                    itemData="{{listModel.getCurrent()}}"
                    attr:key="{{listModel.getCurrent().key}}"
                    backgroundStyle="{{backgroundStyle}}"
                    on:click="_onGroupClick(listModel.getCurrent().dispItem)"/>
    </ws:if>
    <ws:else> <!-- Запись -->
        <ws:if data="{{listModel.isShouldBeDrawnItem(listModel.getCurrent())}}">

            <!-- Перетаскивается запись в позицию перед текущей -->
            <ws:partial if="{{ listModel.getCurrent().dragTargetPosition === 'before' }}"
                        template="ITEM"
                        attr:key="{{ listModel.getCurrent().draggingItemData.key }}__dragged"
                        itemData="{{ listModel.getCurrent().draggingItemData }}"/>

            <!-- Добавление записи перед текущей -->
            <ws:partial if="{{ editingItemData && isAdd && listModel.getCurrent().index === editingItemData.index && editingItemData.addPosition === 'top' }}"
                        template="ITEM"
                        itemData="{{ editingItemData }}"
                        attr:key="{{ editingItemData.key }}_addingBefore"
                        wrapEditingRow="{{ true }}"/>

            <!-- [ЗАПИСЬ] Текущая запись. Скрыта, если она перетаскивается драг-н-дропом. -->
            <ws:if data="{{ listModel.getCurrent().isVisible !== false }}">

                <ws:partial template="ITEM"
                            wrapEditingRow="{{ editingItemData && (editingItemData.key === listModel.getCurrent().key) }}"
                            itemData="{{ listModel.getCurrent() }}"
                            attr:key="{{ listModel.getCurrent().key }}"/>

                <!-- Подвалы узлов для дерева. Живем так до перехода на новую модель или до ws:fragment. -->
                <!-- В записи подвал не вывести, т.к. редатируемая строка оборачивается в контрол. Контрол может принять только один корневой элемент. -->
                <ws:if data="{{ listModel.getCurrent().nodeFooters && listModel.getCurrent().nodeFooters.length > 0 }}">
                    <ws:partial template="{{ listModel.getCurrent().footerContentTemplate }}" itemData="{{ listModel.getCurrent() }}"/>
                </ws:if>
            </ws:if>

            <!-- Добавление записи после текущей -->
            <ws:partial if="{{ editingItemData && isAdd && listModel.getCurrent().index === editingItemData.index - 1 && editingItemData.addPosition !== 'top'}}"
                        template="ITEM"
                        itemData="{{ editingItemData }}"
                        attr:key="{{ editingItemData.key }}_addingAfter"
                        wrapEditingRow="{{ true }}"/>

            <!-- Перетаскивается запись в позицию после текущей -->
            <ws:partial if="{{ listModel.getCurrent().dragTargetPosition === 'after' }}"
                        template="ITEM"
                        itemData="{{ listModel.getCurrent().draggingItemData }}"
                        attr:key="{{ listModel.getCurrent().draggingItemData.key }}__dragged"/>
        </ws:if>
    </ws:else>


    <ws:partial if="{{ listModel.getCurrent().afterItemTemplate }}"
                template="{{ listModel.getCurrent().afterItemTemplate }}"
                scope="{{ listModel.getCurrent().afterItemTemplateOptions }}"
                itemTemplate="{{ itemTemplate }}"
                listModel="{{ listModel }}"/>
</ws:for>

<ws:if data="{{ listModel.getCount() === 0 && editingItemData && isAdd }}">
    <ws:partial template="ITEM"
                itemData="{{ editingItemData }}"
                attr:key="{{ editingItemData.key }}"
                wrapEditingRow="{{ true }}"/>
</ws:if>
